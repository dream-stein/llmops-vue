import{D as P,b as E,E as m,G as w,s as y}from"./index-DycsMsrq.js";const g="http://127.0.0.1:8080",p={success:0,fail:1,notFound:2,unauthorized:3,forbidden:4,validateError:5},W={str:"字符串",int:"整型",float:"浮点型",bool:"布尔值"},$={access_token:"",expire_at:0},b=P("credential",()=>{const e=E(m.get("credential",$));return{credential:e,update:o=>{e.value=o,m.set("credential",o)},clear:()=>{e.value=$,m.remove("credential")}}}),S=1e5,T={method:"GET",mode:"cors",credentials:"include",headers:new Headers({"Content-Type":"application/json"}),redirect:"follow"},j=(e,t)=>{const r=Object.assign({},T,t),{credential:o,clear:l}=b(),h=o.access_token;h&&r.headers.set("Authorization",`Bearer ${h}`);let c=`${g}${e.startsWith("/")?e:`/${e}`}`;const{method:u,params:d,body:s}=r;if(u==="GET"&&d){const a=[];Object.keys(d).forEach(i=>{a.push(`${i}=${encodeURIComponent(d[i])}`)}),c.search(/\?/)===-1?c+=`?${a.join("&")}`:c+=`&${a.join("&")}`,delete r.params}return s&&(r.body=JSON.stringify(s)),Promise.race([new Promise((a,i)=>{setTimeout(()=>{i("接口已超时")},S)}),new Promise((a,i)=>{globalThis.fetch(c,r).then(async n=>{const f=await n.json();f.code===p.success?a(f):f.code===p.unauthorized?(l(),await w.replace({path:"/auth/login"})):(y.error(f.message),i(new Error(f.message)))}).catch(n=>{y.error(n.message),i(n)})})])},_=async(e,t,r)=>{const o=Object.assign({},T,{method:"POST"},t),{credential:l}=b(),h=l.access_token;h&&o.headers.set("Authorization",`Bearer ${h}`);const c=`${g}${e.startsWith("/")?e:`/${e}`}`,{body:u}=t;u&&(o.body=JSON.stringify(u));const d=await globalThis.fetch(c,o);return k(d,r)},k=(e,t)=>{var c;if(!e.ok)throw new Error("网络请求失败");const r=(c=e.body)==null?void 0:c.getReader(),o=new TextDecoder("utf-8");let l="";const h=()=>{let u=!1;r==null||r.read().then(d=>{if(d.done)return;l+=o.decode(d.value,{stream:!0});const s=l.split(`
`);let a="",i="";try{s.forEach(n=>{n=n.trim(),n.startsWith("event:")?a=n.slice(6).trim():n.startsWith("data:")&&(i=n.slice(5).trim()),n===""&&a!==""&&i!==""&&(t({event:a,data:JSON.parse(i)}),a="",i="")}),l=s.pop()||""}catch{u=!0}u||h()})};h()},v=(e,t={})=>{const o={method:"POST",url:`${g}${e.startsWith("/")?e:`/${e}`}`,headers:{},data:{}};t={...o,...t,headers:{...o.headers,...t.headers}};const{credential:l,clear:h}=b(),c=l.access_token;return c&&t.headers.set("Authorization",`Bearer ${c}`),new Promise((u,d)=>{const s=new XMLHttpRequest;s.open(t.methd,t.url);for(const a in t.headers)s.setRequestHeader(a,t.headers[a]);s.withCredentials=!0,s.responseType="json",s.onreadystatechange=async()=>{if(s.readyState===4)if(s.status===200){const a=s.response;a.code===p.success?u(a):a.code==p.unauthorized?(h(),await w.replace({path:"/auth/login"})):d(s.response)}else d(s)},s.upload.onprogress=t.onprogress,s.send(t.data)})},O=(e,t={})=>j(e,t),C=(e,t={})=>O(e,Object.assign({},t,{method:"GET"})),z=(e,t={})=>O(e,Object.assign({},t,{method:"POST"}));export{b as a,C as g,z as p,_ as s,W as t,v as u};
