import{d as Y,r as C,I,J as Z,c as u,a,f as s,w as l,b as z,e as L,h as x,F as ee,k as te,B as M,C as se,M as N,x as r,y as n,j as c,K as oe,z as h}from"./index-CkVFFWDB.js";import{u as ae}from"./helper-QRapnIPA.js";import{c as le,d as re}from"./dataset-CdeI-RZn.js";const ne={class:"p-6"},ie={class:"flex items-center mb-6 gap-4"},ue={class:"w-[520px] mx-auto"},de={class:"min-h-[calc(100vh-160px)] p-[48px]"},pe={key:0,class:""},ce={key:1,class:""},_e={key:0,class:""},me={key:2,class:""},ve={class:"flex flex-col gap-2"},fe={class:"flex items-center gap-2.5"},ye={class:""},ge={class:"text-gray-700"},xe={class:"text-gray-500"},be={key:0,class:"text-gray-500"},ke={key:1,class:"text-red-700"},we={key:2,class:"text-gray-500"},Ce={key:3,class:"text-gray-500"},ze={class:"flex items-center justify-between px-[48px]"},he={class:"flex items-center gap-2"},De={key:2,class:"flex items-center gap-2"},Te=Y({__name:"CreateView",setup(qe){let _=null,D="";const f=se(),d=C(1),t=I({file_list:[],process_type:"automatic",rule:{separators:["\\n"],chunk_size:500,chunk_overlap:50,pre_process_rules:[]}}),q=C(),b=C(!1),k=I([]);let F=0;const $=async()=>{var y,e;if(d.value===1){if(t.file_list.length===0){N.error("请上传需要处理的文件");return}if(!t.file_list.every(p=>{var i,v;return(v=(i=p.response)==null?void 0:i.data)==null?void 0:v.id})){N.warning("文件正在上传中，请稍等");return}d.value++}else{if(t.process_type==="custom"&&await((y=q.value)==null?void 0:y.validate()))return;try{b.value=!0;const m={upload_file_ids:t.file_list.map(i=>i.response.data.id),process_type:t.process_type};t.process_type==="custom"&&(m.rule={pre_process_rules:[{id:"remove_extra_space",enabled:t.rule.pre_process_rules.includes("remove_extra_space")},{id:"remove_url_and_email",enabled:t.rule.pre_process_rules.includes("remove_url_and_email")}],segment:{separators:t.rule.separators.map(i=>ae(i)),chunk_size:t.rule.chunk_size,chunk_overlap:t.rule.chunk_overlap}}),D=(await le((e=f.params)==null?void 0:e.dataset_id,m)).data.batch,await U(),j(),d.value++}finally{b.value=!1}}},U=async()=>{var p;F++;const e=(await re((p=f.params)==null?void 0:p.dataset_id,D)).data;k.splice(0,k.length,...e),F>=30&&V(),e.every(i=>i.status==="completed"||i.status==="error")&&V()},j=()=>_=setInterval(U,5e3),V=()=>{_&&(clearInterval(_),_=null)};return Z(()=>{_&&(clearInterval(_),_=null)}),(y,e)=>{var B,R;const m=r("icon-left"),p=r("a-button"),i=r("router-link"),v=r("a-step"),E=r("a-steps"),O=r("a-upload"),X=r("a-divider"),J=r("a-input-tag"),g=r("a-form-item"),S=r("a-input-number"),T=r("a-checkbox"),K=r("a-checkbox-group"),P=r("a-form"),A=r("icon-file"),G=r("a-avatar");return n(),u("div",ne,[a("div",ie,[s(i,{to:{name:"space-datasets-documents-list",params:{dataset_id:(B=z(f).params)==null?void 0:B.dataset_id}}},{default:l(()=>[s(p,{size:"mini",type:"text",class:"!text-gray-700"},{icon:l(()=>[s(m)]),_:1})]),_:1},8,["to"]),e[8]||(e[8]=a("div",{class:"text-lg font-bold text-gray-700"},"添加文件",-1))]),a("div",ue,[s(E,{current:d.value},{default:l(()=>[s(v,null,{default:l(()=>e[9]||(e[9]=[c("上传")])),_:1}),s(v,null,{default:l(()=>e[10]||(e[10]=[c("分段设置")])),_:1}),s(v,null,{default:l(()=>e[11]||(e[11]=[c("数据处理")])),_:1})]),_:1},8,["current"])]),a("div",de,[d.value===1?(n(),u("div",pe,[s(O,{"file-list":t.file_list,"onUpdate:fileList":e[0]||(e[0]=o=>t.file_list=o),draggable:"",accept:".doc,.docx,.pdf,.txt,.md,.markdown",limit:10,multiple:"",tip:"支持PDF、TXT、DOC、DOCX、MD，最多可上传10个文件，每个文件的大小不超过10MB","custom-request":o=>{const{fileItem:H,onSuccess:Q,onError:W}=o;return(async()=>{try{const w=await z(oe)(H.file);Q(w)}catch(w){W(w)}})(),{abort:()=>{}}}},null,8,["file-list","custom-request"])])):d.value===2?(n(),u("div",ce,[a("div",{class:L(`px-5 py-4 bg-white rounded-lg border cursor-pointer mb-4 hover:border-blue-700 ${t.process_type==="automatic"?"border-blue-700":""}`),onClick:e[1]||(e[1]=o=>t.process_type="automatic")},e[12]||(e[12]=[a("div",{class:"font-bold text-gray-700 mb-2"},"自动分段与清洗",-1),a("div",{class:"text-gray-500"},"自动分段与预处理规则",-1)]),2),a("div",{class:L(`px-5 py-4 bg-white rounded-lg border cursor-pointer hover:border-blue-700 ${t.process_type==="custom"?"border-blue-700":""}`),onClick:e[6]||(e[6]=o=>t.process_type="custom")},[e[15]||(e[15]=a("div",{class:"font-bold text-gray-700 mb-2"},"自定义",-1)),e[16]||(e[16]=a("div",{class:"text-gray-500"},"自定义分段规则、分段长度与预处理规则",-1)),t.process_type==="custom"?(n(),u("div",_e,[s(X),s(P,{model:t.rule,ref_key:"customRuleFormRef",ref:q,layout:"vertical"},{default:l(()=>[s(g,{field:"separators",label:"分段标识符","asterisk-position":"end",rules:[{required:!0,message:"分段标识符不能为空"}]},{default:l(()=>[s(J,{"model-value":t.rule.separators,"onUpdate:modelValue":e[2]||(e[2]=o=>t.rule.separators=o),placeholder:"请输入分段标识符，按下Enter结束"},null,8,["model-value"])]),_:1}),s(g,{field:"chunk_size",label:"分段最大长度",required:"","asterisk-position":"end",rules:[{required:!0,message:"分段最大长度不能为空"}]},{default:l(()=>[s(S,{"model-value":t.rule.chunk_size,"onUpdate:modelValue":e[3]||(e[3]=o=>t.rule.chunk_size=o),min:100,max:1e3,step:1,"default-value":500,placeholder:"请输入100-1000的数字"},null,8,["model-value"])]),_:1}),s(g,{field:"chunk_overlap",label:"块重叠数",required:"","asterisk-position":"end",rules:[{required:!0,message:"块重叠数不能为空"}]},{default:l(()=>[s(S,{"model-value":t.rule.chunk_overlap,"onUpdate:modelValue":e[4]||(e[4]=o=>t.rule.chunk_overlap=o),min:0,max:500,step:1,"default-value":50,placeholder:"请输入0-500的数字"},null,8,["model-value"])]),_:1}),s(g,{field:"pre_process_rules",label:"文本预处理规则"},{default:l(()=>[s(K,{"model-value":t.rule.pre_process_rules,"onUpdate:modelValue":e[5]||(e[5]=o=>t.rule.pre_process_rules=o),direction:"vertical"},{default:l(()=>[s(T,{value:"remove_extra_space"},{default:l(()=>e[13]||(e[13]=[c(" 替换掉连续的空格、换行符和制表符 ")])),_:1}),s(T,{value:"remove_url_and_email"},{default:l(()=>e[14]||(e[14]=[c("删除所有 URL 和电子邮件")])),_:1})]),_:1},8,["model-value"])]),_:1})]),_:1},8,["model"])])):x("",!0)],2)])):(n(),u("div",me,[e[17]||(e[17]=a("div",{class:"text-gray-900 mb-4 text-base"},"服务器正在处理中",-1)),a("div",ve,[(n(!0),u(ee,null,te(k,o=>(n(),u("div",{key:o.id,class:"flex items-center justify-between px-4 py-3 bg-white rounded-lg border"},[a("div",fe,[s(G,{shape:"square",class:"bg-blue-700",size:32},{default:l(()=>[s(A)]),_:1}),a("div",ye,[a("div",ge,h(o.name),1),a("div",xe,h((o.size/1024).toFixed(2))+"kb",1)])]),o.status==="completed"?(n(),u("div",be,"处理完成")):o.status==="error"?(n(),u("div",ke,"处理出错")):o.segment_count===0?(n(),u("div",we,"0%")):(n(),u("div",Ce,h((o.completed_segment_count/o.segment_count*100).toFixed(2))+"% ",1))]))),128))])]))]),a("div",ze,[e[22]||(e[22]=a("div",{class:""},null,-1)),a("div",he,[d.value==2?(n(),M(p,{key:0,class:"rounded-lg",onClick:e[7]||(e[7]=()=>{d.value>1&&d.value--})},{default:l(()=>e[18]||(e[18]=[c(" 上一步 ")])),_:1})):x("",!0),d.value<=2?(n(),M(p,{key:1,loading:b.value,type:"primary",class:"rounded-lg",onClick:$},{default:l(()=>e[19]||(e[19]=[c(" 下一步 ")])),_:1},8,["loading"])):x("",!0),d.value===3?(n(),u("div",De,[e[21]||(e[21]=a("div",{class:"text-gray-500"},"点击确认不影响数据处理，处理完毕后可进行引用",-1)),s(i,{to:{name:"space-datasets-documents-list",params:{dataset_id:(R=z(f).params)==null?void 0:R.dataset_id}}},{default:l(()=>[s(p,{type:"primary",class:"rounded-lg"},{default:l(()=>e[20]||(e[20]=[c("确定")])),_:1})]),_:1},8,["to"])])):x("",!0)])])])}}});export{Te as default};
