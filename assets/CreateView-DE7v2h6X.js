import{d as Z,b as C,n as L,z as ee,o as n,f as u,g as o,h as s,w as l,u as z,a as c,A as N,i as x,F as te,t as se,c as $,j as ae,x as j,r,v as h}from"./index-4LsbD6di.js";import{c as oe,d as le}from"./dataset-DuCBE7PY.js";import{a as re}from"./upload-file-By-BLAJD.js";const ne=D=>D.replace(/\\n/g,`
`).replace(/\\t/g,"	").replace(/\\r/g,"\r").replace(/\\'/g,"'").replace(/\\"/g,'"').replace(/\\\\/g,"\\"),ie={class:"p-6"},ue={class:"flex items-center mb-6 gap-4"},de={class:"w-[520px] mx-auto"},pe={class:"min-h-[calc(100vh-160px)] p-[48px]"},ce={key:0,class:""},_e={key:1,class:""},me={key:0,class:""},ve={key:2,class:""},fe={class:"flex flex-col gap-2"},ge={class:"flex items-center gap-2.5"},ye={class:""},xe={class:"text-gray-700"},be={class:"text-gray-500"},ke={key:0,class:"text-gray-500"},we={key:1,class:"text-red-700"},Ce={key:2,class:"text-gray-500"},ze={key:3,class:"text-gray-500"},he={class:"flex items-center justify-between px-[48px]"},De={class:"flex items-center gap-2"},qe={key:2,class:"flex items-center gap-2"},Te=Z({__name:"CreateView",setup(D){let _=null,q="";const f=ae(),d=C(1),t=L({file_list:[],process_type:"automatic",rule:{separators:["\\n"],chunk_size:500,chunk_overlap:50,pre_process_rules:[]}}),F=C(),b=C(!1),k=L([]);let U=0;const E=async()=>{var g,e;if(d.value===1){if(t.file_list.length===0){j.error("请上传需要处理的文件");return}if(!t.file_list.every(p=>{var i,v;return(v=(i=p.response)==null?void 0:i.data)==null?void 0:v.id})){j.warning("文件正在上传中，请稍等");return}d.value++}else{if(t.process_type==="custom"&&await((g=F.value)==null?void 0:g.validate()))return;try{b.value=!0;const m={upload_file_ids:t.file_list.map(i=>i.response.data.id),process_type:t.process_type};t.process_type==="custom"&&(m.rule={pre_process_rules:[{id:"remove_extra_space",enabled:t.rule.pre_process_rules.includes("remove_extra_space")},{id:"remove_url_and_email",enabled:t.rule.pre_process_rules.includes("remove_url_and_email")}],segment:{separators:t.rule.separators.map(i=>ne(i)),chunk_size:t.rule.chunk_size,chunk_overlap:t.rule.chunk_overlap}}),q=(await oe((e=f.params)==null?void 0:e.dataset_id,m)).data.batch,await V(),M(),d.value++}finally{b.value=!1}}},V=async()=>{var p;U++;const e=(await le((p=f.params)==null?void 0:p.dataset_id,q)).data;k.splice(0,k.length,...e),U>=30&&S(),e.every(i=>i.status==="completed"||i.status==="error")&&S()},M=()=>_=setInterval(V,5e3),S=()=>{_&&(clearInterval(_),_=null)};return ee(()=>{_&&(clearInterval(_),_=null)}),(g,e)=>{var B,I;const m=r("icon-left"),p=r("a-button"),i=r("router-link"),v=r("a-step"),O=r("a-steps"),X=r("a-upload"),A=r("a-divider"),P=r("a-input-tag"),y=r("a-form-item"),T=r("a-input-number"),R=r("a-checkbox"),G=r("a-checkbox-group"),H=r("a-form"),J=r("icon-file"),K=r("a-avatar");return n(),u("div",ie,[o("div",ue,[s(i,{to:{name:"space-datasets-documents-list",params:{dataset_id:(B=z(f).params)==null?void 0:B.dataset_id}}},{default:l(()=>[s(p,{size:"mini",type:"text",class:"!text-gray-700"},{icon:l(()=>[s(m)]),_:1})]),_:1},8,["to"]),e[8]||(e[8]=o("div",{class:"text-lg font-bold text-gray-700"},"添加文件",-1))]),o("div",de,[s(O,{current:d.value},{default:l(()=>[s(v,null,{default:l(()=>e[9]||(e[9]=[c("上传")])),_:1}),s(v,null,{default:l(()=>e[10]||(e[10]=[c("分段设置")])),_:1}),s(v,null,{default:l(()=>e[11]||(e[11]=[c("数据处理")])),_:1})]),_:1},8,["current"])]),o("div",pe,[d.value===1?(n(),u("div",ce,[s(X,{"file-list":t.file_list,"onUpdate:fileList":e[0]||(e[0]=a=>t.file_list=a),draggable:"",accept:".doc,.docx,.pdf,.txt,.md,.markdown",limit:10,multiple:"",tip:"支持PDF、TXT、DOC、DOCX、MD，最多可上传10个文件，每个文件的大小不超过10MB","custom-request":a=>{const{fileItem:Q,onSuccess:W,onError:Y}=a;return(async()=>{try{const w=await z(re)(Q.file);W(w)}catch(w){Y(w)}})(),{abort:()=>{}}}},null,8,["file-list","custom-request"])])):d.value===2?(n(),u("div",_e,[o("div",{class:N(`px-5 py-4 bg-white rounded-lg border cursor-pointer mb-4 hover:border-blue-700 ${t.process_type==="automatic"?"border-blue-700":""}`),onClick:e[1]||(e[1]=a=>t.process_type="automatic")},e[12]||(e[12]=[o("div",{class:"font-bold text-gray-700 mb-2"},"自动分段与清洗",-1),o("div",{class:"text-gray-500"},"自动分段与预处理规则",-1)]),2),o("div",{class:N(`px-5 py-4 bg-white rounded-lg border cursor-pointer hover:border-blue-700 ${t.process_type==="custom"?"border-blue-700":""}`),onClick:e[6]||(e[6]=a=>t.process_type="custom")},[e[15]||(e[15]=o("div",{class:"font-bold text-gray-700 mb-2"},"自定义",-1)),e[16]||(e[16]=o("div",{class:"text-gray-500"},"自定义分段规则、分段长度与预处理规则",-1)),t.process_type==="custom"?(n(),u("div",me,[s(A),s(H,{model:t.rule,ref_key:"customRuleFormRef",ref:F,layout:"vertical"},{default:l(()=>[s(y,{field:"separators",label:"分段标识符","asterisk-position":"end",rules:[{required:!0,message:"分段标识符不能为空"}]},{default:l(()=>[s(P,{"model-value":t.rule.separators,"onUpdate:modelValue":e[2]||(e[2]=a=>t.rule.separators=a),placeholder:"请输入分段标识符，按下Enter结束"},null,8,["model-value"])]),_:1}),s(y,{field:"chunk_size",label:"分段最大长度",required:"","asterisk-position":"end",rules:[{required:!0,message:"分段最大长度不能为空"}]},{default:l(()=>[s(T,{"model-value":t.rule.chunk_size,"onUpdate:modelValue":e[3]||(e[3]=a=>t.rule.chunk_size=a),min:100,max:1e3,step:1,"default-value":500,placeholder:"请输入100-1000的数字"},null,8,["model-value"])]),_:1}),s(y,{field:"chunk_overlap",label:"块重叠数",required:"","asterisk-position":"end",rules:[{required:!0,message:"块重叠数不能为空"}]},{default:l(()=>[s(T,{"model-value":t.rule.chunk_overlap,"onUpdate:modelValue":e[4]||(e[4]=a=>t.rule.chunk_overlap=a),min:0,max:500,step:1,"default-value":50,placeholder:"请输入0-500的数字"},null,8,["model-value"])]),_:1}),s(y,{field:"pre_process_rules",label:"文本预处理规则"},{default:l(()=>[s(G,{"model-value":t.rule.pre_process_rules,"onUpdate:modelValue":e[5]||(e[5]=a=>t.rule.pre_process_rules=a),direction:"vertical"},{default:l(()=>[s(R,{value:"remove_extra_space"},{default:l(()=>e[13]||(e[13]=[c(" 替换掉连续的空格、换行符和制表符 ")])),_:1}),s(R,{value:"remove_url_and_email"},{default:l(()=>e[14]||(e[14]=[c("删除所有 URL 和电子邮件")])),_:1})]),_:1},8,["model-value"])]),_:1})]),_:1},8,["model"])])):x("",!0)],2)])):(n(),u("div",ve,[e[17]||(e[17]=o("div",{class:"text-gray-900 mb-4 text-base"},"服务器正在处理中",-1)),o("div",fe,[(n(!0),u(te,null,se(k,a=>(n(),u("div",{key:a.id,class:"flex items-center justify-between px-4 py-3 bg-white rounded-lg border"},[o("div",ge,[s(K,{shape:"square",class:"bg-blue-700",size:32},{default:l(()=>[s(J)]),_:1}),o("div",ye,[o("div",xe,h(a.name),1),o("div",be,h((a.size/1024).toFixed(2))+"kb",1)])]),a.status==="completed"?(n(),u("div",ke,"处理完成")):a.status==="error"?(n(),u("div",we,"处理出错")):a.segment_count===0?(n(),u("div",Ce,"0%")):(n(),u("div",ze,h((a.completed_segment_count/a.segment_count*100).toFixed(2))+"% ",1))]))),128))])]))]),o("div",he,[e[22]||(e[22]=o("div",{class:""},null,-1)),o("div",De,[d.value==2?(n(),$(p,{key:0,class:"rounded-lg",onClick:e[7]||(e[7]=()=>{d.value>1&&d.value--})},{default:l(()=>e[18]||(e[18]=[c(" 上一步 ")])),_:1})):x("",!0),d.value<=2?(n(),$(p,{key:1,loading:b.value,type:"primary",class:"rounded-lg",onClick:E},{default:l(()=>e[19]||(e[19]=[c(" 下一步 ")])),_:1},8,["loading"])):x("",!0),d.value===3?(n(),u("div",qe,[e[21]||(e[21]=o("div",{class:"text-gray-500"},"点击确认不影响数据处理，处理完毕后可进行引用",-1)),s(i,{to:{name:"space-datasets-documents-list",params:{dataset_id:(I=z(f).params)==null?void 0:I.dataset_id}}},{default:l(()=>[s(p,{type:"primary",class:"rounded-lg"},{default:l(()=>e[20]||(e[20]=[c("确定")])),_:1})]),_:1},8,["to"])])):x("",!0)])])])}}});export{Te as default};
