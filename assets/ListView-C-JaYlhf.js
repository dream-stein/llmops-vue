import{d as X,r as M,E as ie,C as ce,y as re,z as S,w as a,q as s,t as c,a as o,x as m,e,i as p,c as f,b as t,A as _e,B as ue,F as me,j as pe,f as Q}from"./index-CZ1CCYKZ.js";import{h as fe}from"./moment-C5S46NFB.js";import{g as ge,h as ye,i as be,j as ve}from"./use-dataset-SdF7VfZS.js";import{e as he,f as xe,i as ke}from"./dataset-cqAr0J8j.js";const we={class:"flex items-center justify-between"},Se={class:"text-lg font-bold text-gray-700"},Ce={class:"pt-6"},ze={class:"flex items-center justify-between"},Ue=X({__name:"CreateOrUpdateSegmentModal",props:{dataset_id:{type:String,required:!1},document_id:{type:String,required:!1},segment_id:{type:String,required:!1},visible:{type:Boolean,required:!0},callback:{type:Function,required:!1}},emits:["update:visible"],setup(H,{emit:l}){const d=H,g=l,y=M(!1),u={content:"",keywords:[]},_=ie({...u}),C=M(),b=ce(()=>d.segment_id&&d.segment_id!==""),v=()=>g("update:visible",!1),$=async({errors:z})=>{if(!z)try{y.value=!0,b.value?await he(d.dataset_id,d.document_id,d.segment_id,_):await xe(d.dataset_id,d.document_id,_),g("update:visible",!1),d.callback&&d.callback()}finally{y.value=!1}};return re(()=>d.visible,async z=>{var r,h;if((r=C.value)==null||r.resetFields(),z){if(b.value){const k=(await ke(d.dataset_id,d.document_id,d.segment_id)).data;_.content=k.content,_.keywords=k.keywords}}else(h=C.value)==null||h.resetFields(),Object.assign(_,{...u})}),(z,r)=>{const h=s("icon-close"),x=s("a-button"),k=s("a-textarea"),j=s("a-form-item"),B=s("a-input-tag"),i=s("a-space"),q=s("a-form"),w=s("a-modal");return c(),S(w,{width:520,visible:d.visible,"hide-title":"",footer:!1,"modal-class":"rounded-xl",onCancel:v},{default:a(()=>[o("div",we,[o("div",Se,m(b.value?"更新":"添加")+"片段 ",1),e(x,{type:"text",class:"!text-gray-700",size:"small",onClick:v},{icon:a(()=>[e(h)]),_:1})]),o("div",Ce,[e(q,{ref_key:"formRef",ref:C,model:_,layout:"vertical",onSubmit:$},{default:a(()=>[e(j,{field:"content",label:"片段内容","asterisk-position":"end",rules:[{required:!0,message:"片段内容不能为空"}]},{default:a(()=>[e(k,{"model-value":_.content,"onUpdate:modelValue":r[0]||(r[0]=V=>_.content=V),"auto-size":{minRows:8,maxRows:8},placeholder:"在这里添加文档片段内容"},null,8,["model-value"])]),_:1}),e(j,{field:"keywords",label:"关键词"},{default:a(()=>[e(B,{"model-value":_.keywords,"onUpdate:modelValue":r[1]||(r[1]=V=>_.keywords=V),"max-tag-count":10,placeholder:"请输入该文档片段关键词，最多不超过10个，按Enter输入"},null,8,["model-value"])]),_:1}),o("div",ze,[r[4]||(r[4]=o("div",{class:""},null,-1)),e(i,{size:16},{default:a(()=>[e(x,{class:"rounded-lg",onClick:v},{default:a(()=>r[2]||(r[2]=[p("取消")])),_:1}),e(x,{loading:y.value,type:"primary","html-type":"submit",class:"rounded-lg"},{default:a(()=>r[3]||(r[3]=[p("保存 ")])),_:1},8,["loading"])]),_:1})])]),_:1},8,["model"])])]),_:1},8,["visible"])}}}),je={class:"px-6 pt-6 flex flex-col overflow-hidden h-full"},qe={class:"sticky top-0 z-20 bg-gray-50"},Ve={class:"flex items-center w-full gap-2 mb-6"},De={class:"flex items-center gap-3"},Be={class:"flex flex-col justify-between h-[40px]"},Fe={key:1,class:"text-gray-700"},Re={key:2,class:"flex items-center gap-2"},Ee={key:3,class:"flex items-center gap-2"},Me={class:"flex items-center justify-between mb-6"},$e={class:"flex items-center gap-2 h-8 leading-8 bg-white rounded-lg px-3 text-gray-700 border"},He={key:0,class:"w-2 h-2 bg-green-500 border border-green-700 rounded-sm"},Ne={key:1,class:"w-2 h-2 bg-gray-500 border border-gray-200 rounded-sm"},Oe={class:"flex items-center justify-between mb-2"},Ye={class:"flex items-center"},Ge={class:"flex items-center gap-1 text-xs text-gray-700"},Le={key:0,class:"w-2 h-2 bg-green-500 border border-green-700 rounded-sm"},Te={key:1,class:"w-2 h-2 bg-gray-500 border border-gray-700 rounded-sm"},Ae=["onClick"],Ie={class:"flex items-center justify-between"},Pe={class:"flex items-center gap-3"},We={class:"flex items-center gap-1 text-xs text-gray-500"},Je={class:"flex items-center gap-1 text-xs text-gray-500"},et=X({__name:"ListView",setup(H){var h,x,k,j;const l=_e(),d=ue(),g=M(!1),y=M(""),{document:u}=ge((h=l.params)==null?void 0:h.dataset_id,(x=l.params)==null?void 0:x.document_id),{loading:_,segments:C,paginator:b,loadSegments:v}=ye((k=l.params)==null?void 0:k.dataset_id,(j=l.params)==null?void 0:j.document_id),{handleDelete:$}=be(),{handleUpdate:z}=ve(),r=async B=>{const{scrollTop:i,scrollHeight:q,clientHeight:w}=B.target;if(i+w>=q-10){if(_.value)return;await v()}};return(B,i)=>{var L,T,A,I,P,W,J;const q=s("icon-left"),w=s("a-button"),V=s("router-link"),N=s("icon-file"),Z=s("a-avatar"),F=s("a-skeleton-line"),R=s("a-tag"),ee=s("a-input-search"),O=s("a-space"),te=s("a-divider"),ae=s("a-switch"),se=s("icon-bookmark"),oe=s("icon-pushpin"),ne=s("icon-delete"),le=s("a-card"),E=s("a-col"),de=s("a-empty"),Y=s("a-row"),G=s("a-spin");return c(),f("div",je,[o("div",qe,[o("div",Ve,[e(V,{to:{name:"space-datasets-documents-list",params:{dataset_id:(L=t(l).params)==null?void 0:L.dataset_id,document_id:(T=t(l).params)==null?void 0:T.document_id}}},{default:a(()=>[e(w,{size:"mini",type:"text",class:"!text-gray-700"},{icon:a(()=>[e(q)]),_:1})]),_:1},8,["to"]),o("div",De,[e(Z,{size:40,shape:"square",class:"rounded-lg bg-blue-700"},{default:a(()=>[e(N)]),_:1}),o("div",Be,[(A=t(u))!=null&&A.name?(c(),f("div",Fe,"文档 / "+m(t(u).name),1)):(c(),S(F,{key:0,widths:[100]})),(I=t(u))!=null&&I.name?(c(),f("div",Ee,[e(R,{size:"small",class:"rounded h-[18px] leading-[18px] bg-gray-200 text-gray-500"},{default:a(()=>[p(m(t(u).segment_count)+" 文档片段 ",1)]),_:1}),e(R,{size:"small",class:"rounded h-[18px] leading-[18px] bg-gray-200 text-gray-500"},{default:a(()=>[p(m(t(u).hit_count)+" 命中 ",1)]),_:1}),e(R,{size:"small",class:"rounded h-[18px] leading-[18px] bg-gray-200 text-gray-500"},{default:a(()=>[p(m(t(fe)(t(u).updated_at).format("YYYY-MM-DD HH:mm"))+" 最后编辑 ",1)]),_:1})])):(c(),f("div",Re,[e(F,{widths:[60],"line-height":18}),e(F,{widths:[60],"line-height":18}),e(F,{widths:[60],"line-height":18})]))])])]),o("div",Me,[e(ee,{"default-value":((P=t(l).query)==null?void 0:P.search_word)||"",placeholder:"请输入关键词搜索片段",class:"w-[240px] bg-white rounded-lg border-gray-200",onSearch:i[0]||(i[0]=n=>{t(d).push({path:t(l).path,query:{search_word:n}})})},null,8,["default-value"]),e(O,{size:12},{default:a(()=>[o("div",$e,[t(u).enabled?(c(),f("div",He)):(c(),f("div",Ne)),p(" "+m(t(u).enabled?"可用":"已禁用"),1)]),e(w,{type:"primary",class:"rounded-lg",onClick:i[1]||(i[1]=()=>{g.value=!0,y.value=""})},{icon:a(()=>[e(N)]),default:a(()=>[i[3]||(i[3]=p(" 添加片段 "))]),_:1})]),_:1})])]),e(G,{loading:t(_),class:"block h-full w-full scrollbar-w-none overflow-scroll",onScroll:r},{default:a(()=>[e(Y,{gutter:[20,20]},{default:a(()=>[(c(!0),f(me,null,pe(t(C),n=>(c(),S(E,{key:n.id,span:6},{default:a(()=>[e(le,{hoverable:"",class:"cursor-pointer rounded-lg"},{default:a(()=>[o("div",Oe,[e(R,{size:"small",class:"rounded-md text-gray-500"},{default:a(()=>[p(" #"+m(n.position.toString().padStart(3,"0")),1)]),_:2},1024),o("div",Ye,[o("div",Ge,[p(m(n.enabled?"已启用":"已禁用")+" ",1),n.enabled?(c(),f("div",Le)):(c(),f("div",Te))]),e(te,{direction:"vertical"}),e(ae,{"model-value":n.enabled,"onUpdate:modelValue":U=>n.enabled=U,disabled:n.status!=="completed",onChange:async U=>{var D,K;return await t(z)((D=t(l).params)==null?void 0:D.dataset_id,(K=t(l).params)==null?void 0:K.document_id,n.id,U)},"checked-color":"#10b981","unchecked-color":"#556581",type:"round",size:"small"},null,8,["model-value","onUpdate:modelValue","disabled","onChange"])])]),o("div",{class:"leading-[18px] text-gray-700 h-[72px] line-clamp-4 mb-2 break-all",onClick:()=>{y.value=n.id,g.value=!0}},m(n.content),9,Ae),o("div",Ie,[o("div",Pe,[o("div",We,[e(se),p(" "+m(n.character_count)+" 字符 ",1)]),o("div",Je,[e(oe),p(" "+m(n.hit_count)+" 命中 ",1)])]),e(w,{type:"text",size:"mini",class:"!text-gray-500",onClick:async()=>{var U,D;return await t($)((U=t(l).params)==null?void 0:U.dataset_id,(D=t(l).params)==null?void 0:D.document_id,n.id,()=>t(v)(!0))}},{icon:a(()=>[e(ne)]),_:2},1032,["onClick"])])]),_:2},1024)]),_:2},1024))),128)),t(C).length===0?(c(),S(E,{key:0,span:24},{default:a(()=>[e(de,{description:"没有可用的文档片段",class:"h-[400px] flex flex-col items-center justify-center"})]),_:1})):Q("",!0)]),_:1}),t(b).total_page>=2?(c(),S(Y,{key:0},{default:a(()=>[t(b).current_page<=t(b).total_page?(c(),S(E,{key:0,span:24,align:"center"},{default:a(()=>[e(O,{class:"my-4"},{default:a(()=>[e(G),i[4]||(i[4]=o("div",{class:"text-gray-400"},"加载中",-1))]),_:1})]),_:1})):(c(),S(E,{key:1,span:24,align:"center"},{default:a(()=>i[5]||(i[5]=[o("div",{class:"text-gray-400 my-4"},"数据已加载完成",-1)])),_:1}))]),_:1})):Q("",!0)]),_:1},8,["loading"]),e(Ue,{visible:g.value,"onUpdate:visible":i[2]||(i[2]=n=>g.value=n),dataset_id:(W=t(l).params)==null?void 0:W.dataset_id,document_id:(J=t(l).params)==null?void 0:J.document_id,segment_id:y.value,callback:()=>t(v)(!0)},null,8,["visible","dataset_id","document_id","segment_id","callback"])])}}});export{et as default};
